LOGSTASH_VERSION = '1.1.9'
LOGSTASH_CHECKSUM = 'e444e89a90583a75c2d6539e5222e2803621baa0ae94cb77dbbcebacdc0c3fc7'

GROK_VERSION = '1.20110630.1'
GROK_CHECKSUM = 'a37f221824df11df75443150641aee2ad9b539de124a6dc939facd2753cac96f'

ELASTICSEARCH_VERSION  = '0.20.2'
ELASTICSEARCH_CHECKSUM = '065a93e2f73f41d84d4b811ca9baf40fce26130099b7dec9b4bb746d553b14b5'

BUILD_REQUIRES = [
  # grok
  'dh-make', 'devscripts', 'ctags', 'gperf', 'libevent-dev',
  'bison', 'flex', 'libpcre3-dev',
  'libtokyocabinet-dev', 'libevent-1.4-2', 'libtokyocabinet8' ]

ARCH=`dpkg-architecture -qDEB_BUILD_ARCH`.strip

require 'evoker'
require 'evoker/local_cache'

desc "Download and build all packages"
task :packages
task :default => :packages

def package
  pkg = yield
  pkg.comment ||= File.basename(pkg.to_s)
  task :packages => pkg
  pkg
end

package do
  Evoker::cached_wget(
    "https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-#{ELASTICSEARCH_VERSION}.deb",
    :checksum => ELASTICSEARCH_CHECKSUM)
end

package do
  grok_src = Evoker::cached_wget(
    "http://semicomplete.googlecode.com/files/grok-#{GROK_VERSION}.tar.gz",
    :checksum => GROK_CHECKSUM)

  file "grok_#{GROK_VERSION}_#{ARCH}.deb" => [grok_src, "grok-Makefile.patch"] do
    rm_rf "grok-#{GROK_VERSION}"
    sh "tar -xzf #{grok_src}"
    chdir "grok-#{GROK_VERSION}" do
      sh "patch -p1 < ../grok-Makefile.patch"
      sh "make package-debian"
    end
  end
end

package do
  logstash_jar = Evoker::cached_wget(
    "https://logstash.objects.dreamhost.com/release/logstash-#{LOGSTASH_VERSION}-monolithic.jar",
    :output_file => 'logstash.jar',
    :checksum => LOGSTASH_CHECKSUM)

  file "logstash_#{LOGSTASH_VERSION}_all.deb" => logstash_jar do
    sh <<EOF
      fpm -s dir -t deb -n logstash -v #{LOGSTASH_VERSION} -a all \\
          --url http://www.logstash.net/ --description 'Logstash jar' \\
          --depends grok \\
          --depends 'java7-runtime-headless | java6-runtime-headless | java7-runtime | java6-runtime' \\
          --deb-user root --deb-group root \
          --prefix /usr/lib/logstash #{logstash_jar}
EOF
  end
end

